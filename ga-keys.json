import { BetaAnalyticsDataClient } from '@google-analytics/data';
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

const PROPERTY_ID = '517655408';

const serviceAccountPath = path.join(process.cwd(), 'service-account.json');
const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, 'utf-8'));

const analyticsDataClient = new BetaAnalyticsDataClient({
  credentials: {
    client_email: serviceAccount.client_email,
    private_key: serviceAccount.private_key,
  },
});

export async function GET() {
  try {
    const [response] = await analyticsDataClient.runReport({
      property: `properties/${PROPERTY_ID}`,
      dateRanges: [{ startDate: '2023-01-01', endDate: 'today' }],
      metrics: [{ name: 'activeUsers' }],
    });

    return NextResponse.json({ rows: response.rows || [] });
  } catch (error: any) {
    console.error('GA4 API Error:', error);
    return NextResponse.json({ error: 'Failed', details: error.message }, { status: 500 });
  }
}
